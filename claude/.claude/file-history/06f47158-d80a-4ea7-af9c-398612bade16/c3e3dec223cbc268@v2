#!/usr/bin/env python3
"""
Script para transcrever arquivos de √°udio da pasta Downloads.
Requer: pip install openai-whisper
"""

import os
import glob
import whisper
from datetime import datetime

# Configura√ß√µes
PASTA_DOWNLOADS = os.path.expanduser("~/Downloads")
ARQUIVO_SAIDA = os.path.join(PASTA_DOWNLOADS, "transcricoes.txt")
# Extens√µes de √°udio suportadas
EXTENSOES_AUDIO = ["*.mp3", "*.mp4", "*.wav", "*.m4a", "*.ogg", "*.flac", "*.aac", "*.wma"]

# Modelos dispon√≠veis: tiny, base, small, medium, large
# tiny/base s√£o mais r√°pidos, medium/large s√£o mais precisos
MODELO_WHISPER = "base"


def encontrar_audios(caminho_pasta):
    """Encontra todos os arquivos de √°udio na pasta especificada."""
    arquivos_audio = []
    for extensao in EXTENSOES_AUDIO:
        pattern = os.path.join(caminho_pasta, extensao)
        arquivos_audio.extend(glob.glob(pattern))
    return sorted(arquivos_audio)


def transcrever_audio(caminho_audio, modelo):
    """Transcreve um √∫nico arquivo de √°udio."""
    print(f"\nüéß Transcrevendo: {os.path.basename(caminho_audio)}")
    resultado = model.transcribe(caminho_audio, language="pt")
    return resultado["text"]


def salvar_transcricao(transcricoes, caminho_saida):
    """Salva as transcri√ß√µes em um arquivo de texto."""
    with open(caminho_saida, "w", encoding="utf-8") as f:
        f.write(f"Transcri√ß√µes geradas em: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n")
        f.write("=" * 80 + "\n\n")
        f.write(transcricoes)
    print(f"\n‚úÖ Transcri√ß√µes salvas em: {caminho_saida}")


def main():
    print("=" * 50)
    print("üìù Transcritor de √Åudios com Whisper")
    print("=" * 50)

    # Encontrar arquivos de √°udio
    audios = encontrar_audios(PASTA_DOWNLOADS)

    if not audios:
        print(f"\n‚ö†Ô∏è  Nenhum arquivo de √°udio encontrado em {PASTA_DOWNLOADS}")
        return

    print(f"\nüìÅ {len(audios)} arquivo(s) de √°udio encontrado(s):")
    for audio in audios:
        print(f"   - {os.path.basename(audio)}")

    # Carregar modelo Whisper
    print(f"\n‚è≥ Carregando modelo Whisper '{MODELO_WHISPER}'...")
    global model
    model = whisper.load_model(MODELO_WHISPER)
    print("‚úÖ Modelo carregado!")

    # Transcrever cada arquivo
    texto_completo = ""

    for i, caminho_audio in enumerate(audios, 1):
        try:
            texto = transcrever_audio(caminho_audio, model)
            nome_arquivo = os.path.basename(caminho_audio)

            texto_completo += f"{'=' * 80}\n"
            texto_completo += f"Arquivo {i}/{len(audios)}: {nome_arquivo}\n"
            texto_completo += f"{'=' * 80}\n"
            texto_completo += texto + "\n\n"

            print(f"‚úÖ Conclu√≠do: {nome_arquivo}")

        except Exception as e:
            erro_msg = f"‚ùå Erro ao transcrever {os.path.basename(caminho_audio)}: {e}\n\n"
            print(erro_msg)
            texto_completo += erro_msg

    # Salvar resultado
    salvar_transcricao(texto_completo, ARQUIVO_SAIDA)
    print("\nüéâ Processo conclu√≠do!")


if __name__ == "__main__":
    main()
